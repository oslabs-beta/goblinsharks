// src/components/Data.tsx
const json = `
  {
    "Query": {
      "state": [
        {
          "speed": 0.5163,
          "frequency": 1,
          "time": 1566597539284
        },
        {
          "speed": 0.0207,
          "frequency": 1,
          "time": 1566597539659
        },
        {
          "speed": 0.0349,
          "frequency": 1,
          "time": 1566597539940
        },
        {
          "speed": 0.018,
          "frequency": 1,
          "time": 1566597540259
        },
        {
          "speed": 0.0164,
          "frequency": 1,
          "time": 1566597540622
        },
        {
          "speed": 0.0174,
          "frequency": 1,
          "time": 1566597540903
        },
        {
          "speed": 0.0166,
          "frequency": 1,
          "time": 1566597541055
        },
        {
          "speed": 0.0175,
          "frequency": 1,
          "time": 1566597541220
        },
        {
          "speed": 0.0173,
          "frequency": 1,
          "time": 1566597541360
        },
        {
          "speed": 0.0167,
          "frequency": 1,
          "time": 1566597541510
        },
        {
          "speed": 0.0139,
          "frequency": 1,
          "time": 1566597541653
        },
        {
          "speed": 0.0163,
          "frequency": 1,
          "time": 1566597541801
        },
        {
          "speed": 0.393,
          "frequency": 1,
          "time": 1566597541939
        },
        {
          "speed": 0.0165,
          "frequency": 1,
          "time": 1566597542080
        },
        {
          "speed": 0.0119,
          "frequency": 1,
          "time": 1566597542220
        },
        {
          "speed": 0.0115,
          "frequency": 1,
          "time": 1566597542369
        },
        {
          "speed": 0.0341,
          "frequency": 1,
          "time": 1566597542515
        },
        {
          "speed": 0.0132,
          "frequency": 1,
          "time": 1566597542655
        },
        {
          "speed": 0.013,
          "frequency": 1,
          "time": 1566597542811
        },
        {
          "speed": 0.0127,
          "frequency": 1,
          "time": 1566597542968
        },
        {
          "speed": 0.0132,
          "frequency": 1,
          "time": 1566597543292
        },
        {
          "speed": 0.0142,
          "frequency": 1,
          "time": 1566597543429
        },
        {
          "speed": 0.0177,
          "frequency": 1,
          "time": 1566597543552
        },
        {
          "speed": 0.0174,
          "frequency": 1,
          "time": 1566597546755
        },
        {
          "speed": 0.0128,
          "frequency": 1,
          "time": 1566597548458
        },
        {
          "speed": 0.0115,
          "frequency": 1,
          "time": 1566597548602
        },
        {
          "speed": 0.027,
          "frequency": 1,
          "time": 1566597560604
        },
        {
          "speed": 0.0196,
          "frequency": 1,
          "time": 1566597561247
        },
        {
          "speed": 0.0158,
          "frequency": 1,
          "time": 1566597561580
        },
        {
          "speed": 0.0142,
          "frequency": 1,
          "time": 1566597561879
        },
        {
          "speed": 0.0144,
          "frequency": 1,
          "time": 1566597562086
        },
        {
          "speed": 0.0156,
          "frequency": 1,
          "time": 1566597562253
        },
        {
          "speed": 0.0221,
          "frequency": 1,
          "time": 1566597562388
        },
        {
          "speed": 0.0141,
          "frequency": 1,
          "time": 1566597565275
        },
        {
          "speed": 0.8441,
          "frequency": 1,
          "time": 1566612938440
        },
        {
          "speed": 0.3572,
          "frequency": 1,
          "time": 1566614886407
        },
        {
          "speed": 0.6099,
          "frequency": 1,
          "time": 1566666419012
        }
      ]
    },
    "State": {
      "name": [
        {
          "speed": 181.6205,
          "frequency": 1,
          "time": 1566597539466
        },
        {
          "speed": 82.5593,
          "frequency": 1,
          "time": 1566597539742
        },
        {
          "speed": 49.1865,
          "frequency": 1,
          "time": 1566597539990
        },
        {
          "speed": 59.61,
          "frequency": 1,
          "time": 1566597540319
        },
        {
          "speed": 28.845,
          "frequency": 1,
          "time": 1566597540651
        },
        {
          "speed": 32.7117,
          "frequency": 1,
          "time": 1566597540936
        },
        {
          "speed": 39.8117,
          "frequency": 1,
          "time": 1566597541095
        },
        {
          "speed": 28.0282,
          "frequency": 1,
          "time": 1566597541248
        },
        {
          "speed": 31.6636,
          "frequency": 1,
          "time": 1566597541392
        },
        {
          "speed": 28.875,
          "frequency": 1,
          "time": 1566597541539
        },
        {
          "speed": 36.4943,
          "frequency": 1,
          "time": 1566597541690
        },
        {
          "speed": 27.7977,
          "frequency": 1,
          "time": 1566597541829
        },
        {
          "speed": 29.4546,
          "frequency": 1,
          "time": 1566597541971
        },
        {
          "speed": 27.1216,
          "frequency": 1,
          "time": 1566597542108
        },
        {
          "speed": 27.6302,
          "frequency": 1,
          "time": 1566597542248
        },
        {
          "speed": 28.0084,
          "frequency": 1,
          "time": 1566597542397
        },
        {
          "speed": 30.1187,
          "frequency": 1,
          "time": 1566597542545
        },
        {
          "speed": 26.5996,
          "frequency": 1,
          "time": 1566597542681
        },
        {
          "speed": 32.018,
          "frequency": 1,
          "time": 1566597542843
        },
        {
          "speed": 26.9528,
          "frequency": 1,
          "time": 1566597542995
        },
        {
          "speed": 28.9677,
          "frequency": 1,
          "time": 1566597543321
        },
        {
          "speed": 30.8605,
          "frequency": 1,
          "time": 1566597543460
        },
        {
          "speed": 30.7562,
          "frequency": 1,
          "time": 1566597543583
        },
        {
          "speed": 55.8137,
          "frequency": 1,
          "time": 1566597546811
        },
        {
          "speed": 29.0806,
          "frequency": 1,
          "time": 1566597548488
        },
        {
          "speed": 43.8043,
          "frequency": 1,
          "time": 1566597548646
        },
        {
          "speed": 98.9929,
          "frequency": 1,
          "time": 1566597560703
        },
        {
          "speed": 37.3496,
          "frequency": 1,
          "time": 1566597561284
        },
        {
          "speed": 28.5807,
          "frequency": 1,
          "time": 1566597561609
        },
        {
          "speed": 29.4349,
          "frequency": 1,
          "time": 1566597561908
        },
        {
          "speed": 34.1394,
          "frequency": 1,
          "time": 1566597562121
        },
        {
          "speed": 32.8373,
          "frequency": 1,
          "time": 1566597562286
        },
        {
          "speed": 60.5566,
          "frequency": 1,
          "time": 1566597562448
        },
        {
          "speed": 34.8229,
          "frequency": 1,
          "time": 1566597565311
        },
        {
          "speed": 107.7019,
          "frequency": 1,
          "time": 1566612938550
        },
        {
          "speed": 87.0415,
          "frequency": 1,
          "time": 1566614886495
        },
        {
          "speed": 102.4181,
          "frequency": 1,
          "time": 1566666419116
        }
      ],
      "total_dosage": [
        {
          "speed": 175.7638,
          "frequency": 1,
          "time": 1566597546931
        },
        {
          "speed": 33.083,
          "frequency": 1,
          "time": 1566597548492
        },
        {
          "speed": 62.5662,
          "frequency": 1,
          "time": 1566597548665
        },
        {
          "speed": 102.894,
          "frequency": 1,
          "time": 1566597560708
        },
        {
          "speed": 33.9674,
          "frequency": 1,
          "time": 1566597561281
        },
        {
          "speed": 37.6461,
          "frequency": 1,
          "time": 1566597561618
        },
        {
          "speed": 38.5083,
          "frequency": 1,
          "time": 1566597561917
        },
        {
          "speed": 46.4094,
          "frequency": 1,
          "time": 1566597562133
        },
        {
          "speed": 32.4571,
          "frequency": 1,
          "time": 1566597562286
        },
        {
          "speed": 58.4701,
          "frequency": 1,
          "time": 1566597562446
        },
        {
          "speed": 32.5136,
          "frequency": 1,
          "time": 1566597565308
        },
        {
          "speed": 149.7356,
          "frequency": 1,
          "time": 1566612938593
        },
        {
          "speed": 84.7058,
          "frequency": 1,
          "time": 1566614886494
        },
        {
          "speed": 221.0504,
          "frequency": 1,
          "time": 1566666419236
        }
      ],
      "county": [
        {
          "speed": 0.1342,
          "frequency": 1,
          "time": 1566597560605
        },
        {
          "speed": 0.021,
          "frequency": 1,
          "time": 1566597561247
        },
        {
          "speed": 0.0126,
          "frequency": 1,
          "time": 1566597561580
        },
        {
          "speed": 0.0112,
          "frequency": 1,
          "time": 1566597561879
        },
        {
          "speed": 0.0073,
          "frequency": 1,
          "time": 1566597562086
        },
        {
          "speed": 0.0125,
          "frequency": 1,
          "time": 1566597562254
        },
        {
          "speed": 0.0128,
          "frequency": 1,
          "time": 1566597562388
        },
        {
          "speed": 0.013,
          "frequency": 1,
          "time": 1566597565276
        },
        {
          "speed": 0.1106,
          "frequency": 1,
          "time": 1566612938444
        },
        {
          "speed": 0.0569,
          "frequency": 1,
          "time": 1566614886410
        },
        {
          "speed": 0.086,
          "frequency": 1,
          "time": 1566666419016
        }
      ],
      "total_manufactured": [
        {
          "speed": 21065.0435,
          "frequency": 1,
          "time": 1566597586341
        },
        {
          "speed": 22419.9612,
          "frequency": 1,
          "time": 1566614908829
        }
      ]
    },
    "County": {
      "name": [
        {
          "speed": 0.9707,
          "frequency": 1,
          "time": 1566597560607
        },
        {
          "speed": 0.042,
          "frequency": 1,
          "time": 1566597561247
        },
        {
          "speed": 0.0304,
          "frequency": 1,
          "time": 1566597561580
        },
        {
          "speed": 0.03,
          "frequency": 1,
          "time": 1566597561879
        },
        {
          "speed": 0.0285,
          "frequency": 1,
          "time": 1566597562087
        },
        {
          "speed": 0.0319,
          "frequency": 1,
          "time": 1566597562254
        },
        {
          "speed": 0.0771,
          "frequency": 1,
          "time": 1566597562388
        },
        {
          "speed": 0.0312,
          "frequency": 1,
          "time": 1566597565276
        },
        {
          "speed": 0.4418,
          "frequency": 1,
          "time": 1566612938445
        },
        {
          "speed": 0.3619,
          "frequency": 1,
          "time": 1566614886410
        },
        {
          "speed": 0.4117,
          "frequency": 1,
          "time": 1566666419017
        }
      ],
      "total_dosage": [
        {
          "speed": 115.2887,
          "frequency": 1,
          "time": 1566597560721
        },
        {
          "speed": 45.2919,
          "frequency": 1,
          "time": 1566597561293
        },
        {
          "speed": 46.1291,
          "frequency": 1,
          "time": 1566597561627
        },
        {
          "speed": 37.8702,
          "frequency": 1,
          "time": 1566597561917
        },
        {
          "speed": 48.3719,
          "frequency": 1,
          "time": 1566597562135
        },
        {
          "speed": 43.1748,
          "frequency": 1,
          "time": 1566597562297
        },
        {
          "speed": 58.6131,
          "frequency": 1,
          "time": 1566597562447
        },
        {
          "speed": 99.1607,
          "frequency": 1,
          "time": 1566597565375
        },
        {
          "speed": 147.5423,
          "frequency": 1,
          "time": 1566612938592
        },
        {
          "speed": 87.2113,
          "frequency": 1,
          "time": 1566614886497
        },
        {
          "speed": 220.2327,
          "frequency": 1,
          "time": 1566666419236
        }
      ]
    }
  }
`;

// Import the data.
const data = JSON.parse(json);

// Types.
type RequestObject = {
  speed: number,
  time: number,
  frequency: number 
}

// Output object.
const processedData = {
  overview: getOverviewData(data),
  resolvers: getResolversData(data),
};

/**
 * For Preparing Overview data.
 * @param data 
 */
function getOverviewData (data: object) {
  // Init data to return.
  let minTS = Infinity;
  let maxTS = -Infinity;

  // Gets min and max TS.
  for (var entrypoint in data['Query']) {  
    data['Query'][entrypoint].forEach((request: RequestObject) => {
      minTS = request.time < minTS ? request.time : minTS;
      maxTS = request.time > maxTS ? request.time : maxTS;
    }
  )};

  // Init object of processed data to return.
  const returnData = {
    summary: getOverviewSummaryData(data),
    requests: getOverviewRequestsData(data),
    response: getOverviewResponseData(data),
  };

  // Gets summary data from 'data'.
  function getOverviewSummaryData (data: object) {
    // Init data to return.
    const rtnObj = {
      'numTotalRequests': 0,
    };

    // Count total requests.
    for (var entrypoint in data['Query']) {  
      rtnObj.numTotalRequests += data['Query'][entrypoint].length;
    }

    // Return the data.
    return rtnObj;
  }
  
  // Gets Requests data from 'data'.
  function getOverviewRequestsData (data: object) {
    // Init data to return.
    const rtnObj = {
      'times': [''],
      'rpm': [null],
    };

    // Counts total requests.
    const tempData = { "count": {} };
    for (var entrypoint in data['Query']) {
      data['Query'][entrypoint].forEach((request: RequestObject) => {
        // Get the bin of the data.
        let bin = Number(Math.floor((request.time - minTS)/1000)*1000 + minTS);
        tempData["count"][bin] = bin in tempData["count"] ? tempData["count"][bin] + 1 : 1;
      })
    }
    console.log('line 714: ', Object.keys(tempData["count"]).map(key => [Number(key), tempData['count'][key]]));
    // Cast the counts obj to array and sort.
    const tempDataAsSortedArray = Object.keys(tempData["count"])
                                        .map(key => [Number(key), tempData['count'][key]])
                                        .sort((a, b)=> a[0] - b[0]);
    
    rtnObj["times"] = tempDataAsSortedArray.map(el => new Date(el[0]).toTimeString().split(' ')[0]);
    rtnObj["rpm"] = tempDataAsSortedArray.map(el => el[1]);

    return rtnObj;
  };

  // Gets Response data from 'data'.
  function getOverviewResponseData (data: object) {
    // Init data to return.
    const rtnObj = {
      'times': [''],
      '90': [null],
    };

    // Counts total requests.
    const tempData = { "speed": {} , "counts": {} };
    for (var entrypoint in data['Query']) {
      data['Query'][entrypoint].forEach((request: RequestObject) => {
        // Bin the results.
        let bin = Number(Math.floor((request.time - minTS)/1000)*1000 + minTS);
        tempData["counts"][bin] = bin in tempData["counts"] ? tempData["counts"][bin] + 1 : 1;
        tempData["speed"][bin] = bin in tempData["speed"] ? 
          ((tempData["counts"][bin] - 1) * tempData["speed"][bin] / tempData["counts"][bin])
          + (request.speed / tempData["counts"][bin]) : request.speed;
      })
    }
 
    // Cast the counts obj to array and sort.
    const tempDataAsSortedArray = Object.keys(tempData["speed"])
                                        .map(key => [Number(key), tempData['speed'][key]])
                                        .sort((a, b)=> a[0] - b[0]);
    
    rtnObj["times"] = tempDataAsSortedArray.map(el => new Date(el[0]).toTimeString().split(' ')[0]);
    rtnObj["90"] = tempDataAsSortedArray.map(el => el[1]);

    return rtnObj;
  };

  // Return.
  return returnData;
}

/**
 * For Preparing Resolvers data.
 * @param data 
 */
function getResolversData(data: object) {
  const returnData = {
    invocationCounts: getInvocationCountsData(data),
    executionTimes: getExecutionTimesData(data)
  };

  // Invocation Counts data.
  function getInvocationCountsData(data: object) {
    // Init an object to hold our analysis.
    const rtnObj = {};

    // Init a recursive funtion to count nested resolvers.
    const recurseCount = (key: any, element: any) => {
      if (Array.isArray(element)) rtnObj[key] = element.length;
      else for (let el in element) recurseCount(key + ":" + el, element[el]);
    }

    // Fill out the top level Resolvers.
    for (let key in data) if (key !== "Query") recurseCount(key, data[key]);

    // Return
    return rtnObj;
  }

  // Execution Times data.
  function getExecutionTimesData(data: object) {
    // Init an object to hold our analysis.
    const rtnObj = {};

    // Init a recursive funtion to count nested resolvers.
    const recurseSpeed = (key: any, element: any) => {
      if (Array.isArray(element)) {
        let speedArr = element.map(request => request["speed"]);
        rtnObj[key] = speedArr.reduce((a,c) => a+c) / speedArr.length;
      } else for (let el in element) recurseSpeed(key + ":" + el, element[el]);
    }

    // Iterate through top level Resolvers.
    for (let key in data) if (key !== "Query") recurseSpeed(key, data[key]);

    // Return
    return rtnObj;
  }

  // Return.
  return returnData;
}

console.log('data tsx line 825: ', processedData);
// Export.
export { processedData };
